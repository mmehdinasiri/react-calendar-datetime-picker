name: Performance Tests

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  performance:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for proper baseline comparison

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: |
            pnpm-lock.yaml
            ${{ github.event_name == 'pull_request' && 'main-branch/pnpm-lock.yaml' || '' }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library
        run: pnpm run build

      - name: Run performance tests
        run: |
          echo "Running performance tests on current branch..."
          node performance/scripts/extract-performance-metrics.js
        continue-on-error: false

      - name: Generate performance report
        id: performance-report
        run: |
          echo "Generating performance report..."
          node performance/scripts/generate-performance-report.js report performance/results/performance-metrics.json performance/results/performance-report.md

          # Set output for GitHub Actions
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat performance/results/performance-report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout main branch for baseline
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      - name: Measure baseline performance
        if: github.event_name == 'pull_request'
        working-directory: main-branch
        run: |
          echo "Measuring baseline performance on main branch..."

          # Install dependencies for main branch
          pnpm install --frozen-lockfile

          # Build main branch
          pnpm run build

          # Run performance tests on main branch
          node performance/scripts/extract-performance-metrics.js

          # Copy the metrics to the parent directory with a different name
          cp performance/results/performance-metrics.json ../performance/results/performance-metrics-main.json

      - name: Generate comparison report
        if: github.event_name == 'pull_request'
        id: comparison-report
        run: |
          echo "Generating performance comparison report..."
          node performance/scripts/generate-performance-report.js compare performance/results/performance-metrics-main.json performance/results/performance-metrics.json performance/results/performance-comparison.md

          # Set output for GitHub Actions
          echo "comparison<<EOF" >> $GITHUB_OUTPUT
          cat performance/results/performance-comparison.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check performance regression
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for significant performance regressions..."
          node -e "
          const fs = require('fs');

          try {
            const baseline = JSON.parse(fs.readFileSync('performance/results/performance-metrics-main.json', 'utf8'));
            const current = JSON.parse(fs.readFileSync('performance/results/performance-metrics.json', 'utf8'));

            let hasRegression = false;
            const regressions = [];

            Object.entries(current).forEach(([key, val]) => {
              const base = baseline[key];
              if (!base || key.includes('Calls')) return; // Skip missing metrics and call counts

              const percentChange = ((val - base) / base) * 100;

              // Flag if > 15% slower (significant regression)
              if (percentChange > 15) {
                hasRegression = true;
                regressions.push(`âŒ ${key}: ${percentChange.toFixed(1)}% slower (${base.toFixed(2)}ms â†’ ${val.toFixed(2)}ms)`);
              }
            });

            if (hasRegression) {
              console.log('ðŸš¨ PERFORMANCE REGRESSIONS DETECTED:');
              regressions.forEach(reg => console.log(`  ${reg}`));
              console.log('');
              console.log('These changes exceed the 15% performance regression threshold.');
              console.log('Consider optimizing before merging.');
              process.exit(1);
            } else {
              console.log('âœ… No significant performance regressions detected.');
            }
          } catch (error) {
            console.log('âš ï¸ Could not check for regressions:', error.message);
            console.log('Continuing without regression check...');
          }
          "
        continue-on-error: true # Don't block PR, just warn

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${process.env.REPORT}\n\n---\n\n${process.env.COMPARISON}`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('Performance Benchmark Results') &&
              comment.user.type === 'Bot'
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
        env:
          REPORT: ${{ steps.performance-report.outputs.report }}
          COMPARISON: ${{ steps.comparison-report.outputs.comparison }}

      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ github.sha }}
          path: |
            performance/results/performance-metrics.json
            performance/results/performance-report.md
            ${{ github.event_name == 'pull_request' && 'performance/results/performance-comparison.md' || '' }}
            ${{ github.event_name == 'pull_request' && 'performance/results/performance-metrics-main.json' || '' }}