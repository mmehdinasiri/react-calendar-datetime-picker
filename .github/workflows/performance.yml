name: Performance Tests

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  performance:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for proper baseline comparison

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: |
            pnpm-lock.yaml
            ${{ github.event_name == 'pull_request' && 'main-branch/pnpm-lock.yaml' || '' }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library
        run: pnpm run build

      - name: Run performance tests
        run: |
          echo "Running performance tests on current branch..."
          node performance/scripts/extract-performance-metrics.js
        continue-on-error: false

      - name: Generate performance report
        id: performance-report
        run: |
          echo "Generating performance report..."

          # Create a simple script to parse the performance test results
          cat > parse-performance.js << 'EOF'
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('performance-results.json', 'utf8'));

          const metrics = {};

          results.testResults.forEach(testResult => {
            testResult.testResults.forEach(test => {
              const testName = test.fullName;
              const logs = test.logs || [];

              // Extract performance metrics from console.log statements
              logs.forEach(log => {
                // Match patterns like "DtCalendar (1 month) render time: 16.83ms"
                const match = log.match(/([^(]+) \(?([^)]*)\)? render time: ([0-9.]+)ms/);
                if (match) {
                  const [, component, details, time] = match;
                  const key = details ? `${component} (${details})` : component;
                  metrics[key] = parseFloat(time);
                }

                // Match other performance metrics
                const navMatch = log.match(/Month navigation time: ([0-9.]+)ms/);
                if (navMatch) {
                  metrics['Month Navigation'] = parseFloat(navMatch[1]);
                }

                const pickerMatch = log.match(/DtPicker modal open time: ([0-9.]+)ms/);
                if (pickerMatch) {
                  metrics['DtPicker Modal Open'] = parseFloat(pickerMatch[1]);
                }

                const arrayMatch = log.match(/Array\.from calls during re-render: ([0-9]+)/);
                if (arrayMatch) {
                  metrics['Array.from Calls (Re-render)'] = parseInt(arrayMatch[1]);
                }

                const gridNavMatch = log.match(/Month navigation with memoized grids: ([0-9.]+)ms/);
                if (gridNavMatch) {
                  metrics['Memoized Grid Navigation'] = parseFloat(gridNavMatch[1]);
                }
              });
            });
          });

          // Output metrics as JSON
          console.log(JSON.stringify(metrics, null, 2));
          EOF

          node parse-performance.js > performance-metrics.json

          # Create human-readable report
          cat > performance-report.md << 'EOF'
          ## üöÄ Performance Benchmark Results

          ### üìä Current Branch Performance
          | Metric | Value | Status |
          |--------|-------|--------|
          EOF

          # Read metrics and generate table
          node -e "
          const metrics = JSON.parse(require('fs').readFileSync('performance-metrics.json', 'utf8'));
          Object.entries(metrics).forEach(([key, value]) => {
            const unit = key.includes('Calls') ? 'calls' : 'ms';
            const status = key.includes('Calls') ? (value === 0 ? '‚úÖ PASS' : '‚ö†Ô∏è CHECK') :
                          value < 50 ? '‚úÖ PASS' : value < 100 ? '‚ö†Ô∏è SLOW' : '‚ùå FAIL';
            console.log(\`| \${key} | \${value}\${unit} | \${status} |\`);
          });
          " >> performance-report.md

          echo "" >> performance-report.md
          echo "### üìà Performance Targets" >> performance-report.md
          echo "| Metric | Target | Notes |" >> performance-report.md
          echo "|--------|--------|-------|" >> performance-report.md
          echo "| Calendar Render (1 month) | < 100ms | Initial load time |" >> performance-report.md
          echo "| Calendar Render (3 months) | < 200ms | Multi-month view |" >> performance-report.md
          echo "| Re-render (unchanged props) | < 5ms | Memoization effectiveness |" >> performance-report.md
          echo "| Month Navigation | < 50ms | User interaction |" >> performance-report.md
          echo "| Array.from Calls (Re-render) | 0 calls | Static array optimization |" >> performance-report.md

          echo "" >> performance-report.md
          echo "_Generated on $(date)_" >> performance-report.md

          # Set output for GitHub Actions
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat performance-report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout main branch for baseline
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: main-branch

      - name: Measure baseline performance
        if: github.event_name == 'pull_request'
        working-directory: main-branch
        run: |
          echo "Measuring baseline performance on main branch..."

          # Install dependencies for main branch
          pnpm install --frozen-lockfile

          # Build main branch
          pnpm run build

          # Run performance tests on main branch
          node performance/scripts/extract-performance-metrics.js

          # Copy the metrics to the parent directory with a different name
          cp performance-metrics.json ../performance-metrics-main.json

          # Parse main branch results
          cat > parse-performance.js << 'EOF'
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('performance-results-main.json', 'utf8'));

          const metrics = {};

          results.testResults.forEach(testResult => {
            testResult.testResults.forEach(test => {
              const logs = test.logs || [];
              logs.forEach(log => {
                const match = log.match(/([^(]+) \(?([^)]*)\)? render time: ([0-9.]+)ms/);
                if (match) {
                  const [, component, details, time] = match;
                  const key = details ? `${component} (${details})` : component;
                  metrics[key] = parseFloat(time);
                }

                const navMatch = log.match(/Month navigation time: ([0-9.]+)ms/);
                if (navMatch) metrics['Month Navigation'] = parseFloat(navMatch[1]);

                const pickerMatch = log.match(/DtPicker modal open time: ([0-9.]+)ms/);
                if (pickerMatch) metrics['DtPicker Modal Open'] = parseFloat(pickerMatch[1]);

                const arrayMatch = log.match(/Array\.from calls during re-render: ([0-9]+)/);
                if (arrayMatch) metrics['Array.from Calls (Re-render)'] = parseInt(arrayMatch[1]);

                const gridNavMatch = log.match(/Month navigation with memoized grids: ([0-9.]+)ms/);
                if (gridNavMatch) metrics['Memoized Grid Navigation'] = parseFloat(gridNavMatch[1]);
              });
            });
          });

          console.log(JSON.stringify(metrics, null, 2));
          EOF

          node parse-performance.js > performance-metrics-main.json

      - name: Generate comparison report
        if: github.event_name == 'pull_request'
        id: comparison-report
        run: |
          echo "Generating performance comparison report..."

          cat > compare-performance.js << 'EOF'
          const fs = require('fs');

          const current = JSON.parse(fs.readFileSync('performance-metrics.json', 'utf8'));
          const baseline = JSON.parse(fs.readFileSync('performance-metrics-main.json', 'utf8'));

          console.log('# ‚ö° Performance Comparison: PR vs Main Branch');
          console.log('');
          console.log('| Metric | Main Branch | PR Branch | Diff | Change | Status |');
          console.log('|--------|-------------|-----------|------|--------|--------|');

          const allKeys = new Set([...Object.keys(current), ...Object.keys(baseline)]);
          let improved = 0;
          let degraded = 0;

          Array.from(allKeys).sort().forEach(key => {
            const mainVal = baseline[key];
            const prVal = current[key];

            if (mainVal === undefined || prVal === undefined) {
              console.log(`| ${key} | ${mainVal || 'N/A'} | ${prVal || 'N/A'} | N/A | N/A | ‚ùì NEW |`);
              return;
            }

            const isCalls = key.includes('Calls');
            const unit = isCalls ? 'calls' : 'ms';

            let change, status, diffIndicator;
            if (isCalls) {
              // For call counts, lower is better
              change = prVal - mainVal;
              if (change < 0) {
                status = '‚úÖ IMPROVED';
                diffIndicator = 'üü¢';
                improved++;
              } else if (change > 0) {
                status = '‚ùå DEGRADED';
                diffIndicator = 'üî¥';
                degraded++;
              } else {
                status = '‚û°Ô∏è SAME';
                diffIndicator = '‚ö™';
              }
            } else {
              // For time metrics, lower is better
              change = prVal - mainVal;
              const percentChange = mainVal > 0 ? ((change / mainVal) * 100).toFixed(1) : 'N/A';

              if (change < 0) {
                status = `‚úÖ IMPROVED (${Math.abs(percentChange)}% faster)`;
                diffIndicator = 'üü¢';
                improved++;
              } else if (change > 0) {
                status = `‚ùå DEGRADED (${percentChange}% slower)`;
                diffIndicator = 'üî¥';
                degraded++;
              } else {
                status = '‚û°Ô∏è SAME';
                diffIndicator = '‚ö™';
              }
            }

            const changeStr = isCalls ? (change > 0 ? `+${change}` : change.toString()) :
                           change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);

            console.log(`| ${key} | ${mainVal}${unit} | ${prVal}${unit} | ${diffIndicator} ${changeStr}${unit} | ${changeStr}${unit} | ${status} |`);
          });

          console.log('');
          console.log(`## üìä Summary`);
          console.log(`- **${improved}** metrics improved`);
          console.log(`- **${degraded}** metrics degraded`);
          console.log(`- **${Array.from(allKeys).length - improved - degraded}** metrics unchanged`);
          console.log('');
          console.log('_Performance comparison generated automatically_');
          EOF

          node compare-performance.js > performance-comparison.md

          # Set output for GitHub Actions
          echo "comparison<<EOF" >> $GITHUB_OUTPUT
          cat performance-comparison.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check performance regression
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for significant performance regressions..."
          node -e "
          const fs = require('fs');

          try {
            const baseline = JSON.parse(fs.readFileSync('performance-metrics-main.json', 'utf8'));
            const current = JSON.parse(fs.readFileSync('performance-metrics.json', 'utf8'));

            let hasRegression = false;
            const regressions = [];

            Object.entries(current).forEach(([key, val]) => {
              const base = baseline[key];
              if (!base || key.includes('Calls')) return; // Skip missing metrics and call counts

              const percentChange = ((val - base) / base) * 100;

              // Flag if > 15% slower (significant regression)
              if (percentChange > 15) {
                hasRegression = true;
                regressions.push(\`\${key}: \${percentChange.toFixed(1)}% slower (\${base.toFixed(2)}ms ‚Üí \${val.toFixed(2)}ms)\`);
              }
            });

            if (hasRegression) {
              console.log('üö® PERFORMANCE REGRESSIONS DETECTED:');
              regressions.forEach(reg => console.log(\`  ‚ùå \${reg}\`));
              console.log('');
              console.log('These changes exceed the 15% performance regression threshold.');
              console.log('Consider optimizing before merging.');
              process.exit(1);
            } else {
              console.log('‚úÖ No significant performance regressions detected.');
            }
          } catch (error) {
            console.log('‚ö†Ô∏è Could not check for regressions:', error.message);
            console.log('Continuing without regression check...');
          }
          "
        continue-on-error: true # Don't block PR, just warn

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${process.env.REPORT}\n\n---\n\n${process.env.COMPARISON}`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('Performance Benchmark Results') &&
              comment.user.type === 'Bot'
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
        env:
          REPORT: ${{ steps.performance-report.outputs.report }}
          COMPARISON: ${{ steps.comparison-report.outputs.comparison }}

      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ github.sha }}
          path: |
            performance-metrics.json
            performance-report.md
            ${{ github.event_name == 'pull_request' && 'performance-comparison.md' || '' }}
            ${{ github.event_name == 'pull_request' && 'main-branch/performance-metrics-main.json' || '' }}
